<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Тестирование статистических гипотез. Часть 2</title>
    <meta charset="utf-8" />
    <meta name="author" content="Марина Варфоломеева, Юта Тамберг, Вадим Хайтов" />
    <script src="site_libs/header-attrs-2.20/header-attrs.js"></script>
    <link href="site_libs/remark-css-0.0.1/ninjutsu.css" rel="stylesheet" />
    <link href="site_libs/tile-view-0.2.6/tile-view.css" rel="stylesheet" />
    <script src="site_libs/tile-view-0.2.6/tile-view.js"></script>
    <script src="site_libs/fabric-4.3.1/fabric.min.js"></script>
    <link href="site_libs/xaringanExtra-scribble-0.0.1/scribble.css" rel="stylesheet" />
    <script src="site_libs/xaringanExtra-scribble-0.0.1/scribble.js"></script>
    <script>document.addEventListener('DOMContentLoaded', function() { window.xeScribble = new Scribble({"pen_color":["#FF0000"],"pen_size":3,"eraser_size":30,"palette":[]}) })</script>
    <script src="site_libs/mark.js-8.11.1/mark.min.js"></script>
    <link href="site_libs/xaringanExtra-search-0.0.1/search.css" rel="stylesheet" />
    <script src="site_libs/xaringanExtra-search-0.0.1/search.js"></script>
    <script>window.addEventListener('load', function() { window.xeSearch = new RemarkSearch({"position":"bottom-left","caseSensitive":false,"showIcon":false,"autoSearch":true}) })</script>
    <script src="site_libs/xaringanExtra-progressBar-0.0.1/progress-bar.js"></script>
    <script src="site_libs/freezeframe-5.0.2/freezeframe.min.js"></script>
    <script src="site_libs/xaringanExtra-freezeframe-0.0.1/freezeframe-init.js"></script>
    <script id="xaringanExtra-freezeframe-options" type="application/json">{"selector":"img[src$=\"gif\"]","trigger":"click","overlay":false,"responsive":true,"warnings":true}</script>
    <link href="site_libs/tachyons-4.12.0/tachyons.min.css" rel="stylesheet" />
    <!-- https://github.com/fnaufel/xaringan-smartify-->
    <script
    			  src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
    			  integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
    			  crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/fnaufel/xaringan-smartify/smartify.min.js"></script>
    <link rel="stylesheet" href="assets/xaringan-themer.css" type="text/css" />
    <link rel="stylesheet" href="assets/xaringan.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: middle, left, inverse, title-slide

.title[
# Тестирование статистических гипотез. Часть 2
]
.author[
### Марина Варфоломеева, Юта Тамберг, Вадим Хайтов
]

---






## Тестирование гипотез

- Выборочное распределение среднего значения
- Как устроено тестирование гипотез
- t-статистика
- Применение t-теста
- Статистическая значимость

---

class: middle, center, inverse

# Как устроено тестирование гипотез

---

## Сравнение выборок

Различия между выборками не всегда видны невооружённым глазом.

![](images/tres-caracoles-by-Alberto-Villen-on-freeimages.com.jpg)
![](images/tres-caracoles-by-Alberto-Villen-on-freeimages.com.jpg)

.tiny[tres caracoles by Alberto Villen on Freeimages.com]

---

## Нулевая и альтернативная гипотезы

Это первый шаг

![](images/tres-caracoles-by-Alberto-Villen-on-freeimages.com.jpg)
![](images/tres-caracoles-by-Alberto-Villen-on-freeimages.com.jpg)

.tiny[tres caracoles by Alberto Villen on Freeimages.com]

--

- Нулевая гипотеза `\(H_0\)` чаще всего формулируется как **отсутствие различий** между сравниваемыми объектами. Например: Улитки из обеих популяций одинакового размера

- Альтернативная гипотеза `\(H_A\)` формулируется как **присутствие различий**, она обратна нулевой гипотезе, т.е. включает все остальные случаи. Например: Улитки из обеих популяций разного размера.

---

## Нулевая и альтернативная гипотезы — это "два мира"

Вне зависимости от нас, реальность может находиться в одном из двух состояний:

.pull-left[
- `\(H_0\)` верна, улитки одинаковы

![:scale 45%](images/tres-caracoles-by-Alberto-Villen-on-freeimages.com.jpg)
![:scale 45%](images/tres-caracoles-by-Alberto-Villen-on-freeimages.com.jpg)
]
.pull-right[
- `\(H_0\)` неверна, улитки различаются 

![:scale 45%](images/tres-caracoles-by-Alberto-Villen-on-freeimages.com.jpg)
![:scale 30%](images/tres-caracoles-by-Alberto-Villen-on-freeimages.com.jpg)
]

&lt;br /&gt;

--

После статистического теста мы принимаем решение о том, принять или отвергнуть `\(H_0\)`. Но это решение не обязательно окажется верным. Возможно четыре исхода:

.pull-left[
В мире где улитки одинаковы &lt;br/&gt;( `\(H_0\)` верна) мы можем:  
- принять `\(H_0\)` (верное решение),  
- отвергнуть `\(H_0\)` (ошибка).
]
.pull-right[
В мире где улитки различаются &lt;br/&gt;( `\(H_A\)` верна), мы можем:  
- принять `\(H_0\)` (ошибка),  
- либо отвергнуть `\(H_0\)` (верное решение).
]

---

## Верные и неверные решения

.pull-left[
**Ошибка I рода: нашли то, чего нет**
]
.pull-right[
**Ошибка II рода: не нашли то, что было**
]

| 	| `\(H_0\)` верна |	`\(H_0\)` неверна |
|:-----:|:-----:|:-----:|
| Отклонить H0 | Ошибка I рода с вероятностью &lt;span class="orange"&gt;&amp;alpha;&lt;/span&gt;&lt;/br&gt;Ложно-положительный результат | 	Верно |
| Сохранить H0 | Верно | Ошибка II рода с вероятностью &lt;span class= "blue"&gt;&amp;beta;&lt;/span&gt; &lt;/br&gt; Ложно-отрицательный результат |

--

Пока мы будем говорить о том, как контролируют уровень **Ошибок I рода**. 
Про **Ошибки II рода** и **Power analysis** читайте дополнительную литературу.   

---

## Тестирование гипотез: Тестовые статистики

--

#### 1. Формулируем нулевую и альтернативную гипотезы.

Гипотезы выражаются математически в виде тестовых статистик. На этом этапе мы делаем определенные допущения.

--

#### 2. Проверяем __условия применимости__ тестовой статистики.

--

#### 3. По реальным данным вычисляем __эмпирическое значение тестовой статистики__.

--

Дальше мы должны ответить на вопрос:

**Насколько вероятно получить _такое или более экстремальное_ эмпирическое значение, если верна нулевая гипотеза  `\(H_0\)`?**


#### 4. Строим теоретическое распределение тестовой статистики для случая, когда верна `\(H_0\)`, и оцениваем по нему уровень значимости.

--

#### 5. Решаем сохранить или отвергнуть `\(H_0\)`.

Увы, мы не сможем узнать, какая гипотеза верна, но поймем, насколько с ней согласуются исходные данные.

---

class: middle, center, inverse

# Одновыборочный *t*-тест

---

## Размер кладки черепах

Разберемся с одновыборочным `\(t\)`-тестом на вымышленном примере.



Представьте, что в [одной статье](https://edis.ifas.ufl.edu/publication/UW441#:~:text=Reproductive%20rate%3A%20Clutch%20sizes%20range,to%20100%20years%20in%20captivity.) сказано, что средняя плодовитость черепах определенного вида — 8 яиц в кладке.

В вашей выборке из `\(35\)` черепах — `\(\bar x = 9\)`, `\(sd = 2\)`.



Отличается ли приведенное в статье значение от того, что наблюдается в изученной популяции. Можно ли считать, что авторы статьи изучали что-то иное (другой вид, или популяцию из иных условий).   

&lt;!-- Отличается ли реальная плодовитость в обследованной вами популяции черепах от того, что указано в статье? --&gt;

![](images/gopher-tortoise.jpg)


&lt;small&gt;Gopher Tortoise by Judy Gallagher on Flickr&lt;/small&gt;
&lt;!-- https://flic.kr/p/Q2ZozS --&gt;


---

## Одновыборочный t-тест

- `\(H_0: \mu = \mu_0\)` — Реальная средняя плодовитость черепах такая, как в статье.
- `\(H_A: \mu \ne \mu_0\)` — Средняя плодовитость отличается от того, что написано в статье.

`\(\mu_0\)` — это какое-то конкретное значение. В нашей задаче это — 8 яиц в кладке.

&lt;br/&gt;

`$$t = \cfrac{\bar x - \mu}{ sd / \sqrt{n} }$$`

Если выполняется ЦПТ, то одновыборочная `\(t\)`-статистика подчиняется `\(t\)`-распределению  
с числом степеней свободы `\(df = n - 1\)`.

Условия применимости:

- Наблюдения в выборке должны быть независимы друг от друга.
- Объем выборки достаточно велик **или** величины нормально распределены.

---

## Проверяем, нормально ли распределение

![](04_hypothesis_testing_Part_2_files/figure-html/unnamed-chunk-3-1.png)&lt;!-- --&gt;

--

Нет оснований для сомнения, что наша выборка взята из генеральной совокупности с распределением отличающимся от нормального.

---

## Вычислим наблюдаемое значение `\(t\)`-статистики

`$$t = \cfrac{\bar x - \mu}{ sd / \sqrt{n} }$$`
Средняя плодовитость в выборке из 35 черепах `\(\bar x = 9\)`, стандартное отклонение `\(sd = 2\)`.
В статье указана плодовитость `\(8\)`.





`$$t = \cfrac{9 - 8}{ 2 / \sqrt{35} } = 2.96$$`

---

## Насколько это значение согласуется с `\(H_0\)`?

.pull-left[

![](04_hypothesis_testing_Part_2_files/figure-html/unnamed-chunk-5-1.png)&lt;!-- --&gt;

]
.pull-right[

При `\(H_0\)` значение `\(t\)` будет близко к нулю.

Насколько необычны значения t меньше или больше `\(\pm 2.96\)`?

]

---

## Уровень значимости (_p_-value)

.pull-left[

![](04_hypothesis_testing_Part_2_files/figure-html/unnamed-chunk-6-1.png)&lt;!-- --&gt;

]
.pull-right[

__Уровень значимости__ — это вероятность получить значение `\(t\)` меньше или больше данного, если бы `\(H_0\)` была справедлива.

]



---

## Уровень значимости (_p_-value)

.pull-left[

![](04_hypothesis_testing_Part_2_files/figure-html/unnamed-chunk-7-1.png)&lt;!-- --&gt;

]
.pull-right[

Можно вычислить значение `\(p\)`


```r
2 * ( 1 - pt(2.96, df = 35 - 1) )
```

```
[1] 0.005571
```

Если бы плодовитость не отличалось от указанной в статье, получить `\(t\)` меньше или больше `\(2.96\)` (то есть справедливы была бы `\(H_0\)`) можно было бы с вероятностью `\(p = 0.006\)`. 

]

---

## Критический уровень значимости

.pull-left[

![](04_hypothesis_testing_Part_2_files/figure-html/unnamed-chunk-9-1.png)&lt;!-- --&gt;

]
.pull-right[

Критический уровень значимости `\(\alpha\)` — это порог для принятия решений.

Обычно используют `\(\alpha = 0.05\)`. 

`\(\alpha\)` - это допустимая вероятность **Ошибки I рода** (найти отличия там, где их нет).


Если `\(p \le \alpha\)` — отвергаем `\(H_0\)`  и принимаем `\(H_A\)`.

Если `\(p &gt; \alpha\)` — сохраняем `\(H_0\)`,  не можем ее отвергнуть.

]

---

## Принимаем решение

.pull-left[

![](04_hypothesis_testing_Part_2_files/figure-html/unnamed-chunk-10-1.png)&lt;!-- --&gt;

]
.pull-right[

Мы получили `\(p &lt; \alpha\)`, поэтому отвергаем `\(H_0\)` и принимаем `\(H_A\)`.

Указанная в статье плодовитость **статистически значимо** отличается от плодовитости в изученной нами популяции. Мы изучали что-то иное (другую генеральную совокупность)!

--

*At!* Лучше не использовать популярное словосочетание "*достоверно отличается*". Достоверные события - это события, вероятность которых равна 1. 
]

---

## Заблуждения о _p_-values

Это каверзные вопросы, на которые многие отвечают неправильно
--

 Правда ли, что `\(p\)` — вероятность того, что верна сама `\(H_0\)`?  

--

- Нет! Значение `\(p\)` всегда считается __при условии, что `\(H_0\)` верна__. Но `\(H_0\)` может быть неверна.

&lt;br/&gt;

--

Правда ли, что `\(p\)` — это вероятность получить такое значение статистики при справедливой `\(H_0\)`?

--

- Нет! Вероятность вычисляется как площадь под участком кривой.  Конкретное значение статистики — это точка и под ней нет площади.

&lt;br/&gt;

--

Правда ли, что если `\(p &gt; 0.05\)`, то различий между группами на самом деле нет?  

--

- Нет! Это значит, что имеющиеся данные не позволяют отвергнуть нулевую гипотезу. Различия могут быть.

--

*p*-value - это всего лишь вероятность того, что *в мире, где справедлива `\(H_0\)`,* при повторных выборках из той же генеральной совокупности значение выбранной статистики (например *t*) будет больше или равно наблюдаемого в нашей выборке. 


---

class: middle, center, inverse

# Двухвыборочный t-тест

---

## Гипотезы в двухвыборочном `\(t\)`-тесте и тестовая статистика

`\(H_0: \mu_1 - \mu_2 = 0\)` — средние значения не различаются в двух группах

`\(H_A: \mu_1 - \mu_2 \ne 0\)` — средние значения различаются

&lt;br/&gt;

Т.е. нас интересует __разность выборочных средних__.

Ее ожидаемое значение при `\(H_0\)` будет 0.


t-тест в общем виде выглядит так

`$$t=\frac{\text{Наблюдаемая величина - Ожидаемое значение}}{\text{Стандартная ошибка}}$$`
---

## t-тест и его разновидности

Двухвыборочный t-тест используется для проверки значимости различий между средними

`$$t=\frac{(\bar{x}_1 - \bar{x}_2) - (\mu_1 - \mu_2)}{SE_{\bar{x}_1 - \bar{x}_2}} \; = \; \frac{\bar{x}_1 - \bar{x}_2}{SE_{\bar{x}_1 - \bar{x}_2}}$$`

--

`\(SE_{\bar{x}_1 - \bar{x}_2}\)` — стандартная ошибка разности двух средних, может рассчитываться по-разному

- t-тест Стьюдента — если считать, что дисперсии в группах равны
- t-тест Уэлча — если считать, что дисперсии могут быть разными

---

## Стандартная ошибка разности средних в t-тесте Стьюдента

Student 1908

Если группы независимы и **дисперсии в них равны**, то по центральной предельной теореме

`$$SE_{\bar{x}_1 - \bar{x}_2} = \sqrt{ \frac{sd^2}{n_{1}} + \frac{sd^2}{n_{2}}}$$`

Результирующая `\(t\)`-статистика подчиняется `\(t\)`-распределению с  `\(df = n_1 + n_2 - 2\)`.

--

Осторожно, равенство дисперсий в группах —  
это часто нереалистичное предположение!

---

## t-тест Уэлча

Если группы независимы и дисперсии в них неизвестны, но могут быть неравны 

тогда число степенй свободы `\(df\)` (параметр `\(t\)`-распределения)

`$$df_{ Welch-Satterthwaite} \approx \cfrac {\bigg(\cfrac{sd^2_{1}}{n_{1}} + \cfrac{sd^2_{2}}{n_{2}}\bigg)^2}
{\cfrac{1}{n_{1} - 1}\bigg(\cfrac {sd_{1}^2} {n_{1}}\bigg)^2 + \cfrac{1}{n_{2} - 1}\bigg(\cfrac {sd_{2}^2} {n_{2}}\bigg)^2}$$`


t-тестом Уэлча можно пользоваться, даже если дисперсии равны.


---

## Условия применимости двухвыборочного t-теста

- Наблюдения независимы друг от друга.
- Выборки независимы друг от друга.
- Объем выборки достаточно велик или величины нормально распределены.

---

class: middle, center, inverse

# Двухвыборочный t-тест в R

---

## Пример: Гормоны и артериальная гипертензия

Синдром Кушинга — это нарушения уровня артериального давления, вызванные гиперсекрецией кортизола надпочечниками.

В датасете `Cushings` (пакет `MASS`) записаны данные о секреции двух метаболитов при разных типах синдрома (данные из кн. Aitchison, Dunsmore, 1975).

- `Tetrahydrocortisone` — секреция тетрагидрокортизона с мочой (мг/сут.)
- `Pregnanetriol` — секреция прегнантриола с мочой (мг/сут.)
- `Type` — тип синдрома:
    - `a` — аденома
    - `b` — двусторонняя гиперплазия
    - `c` — карцинома
    - `u` — не известно

Давайте сравним секрецию тетрагидрокортизона при аденомe (группа *a*) и двусторонней гиперплазии надпочечников (группа *b*). Различается ли она?

---

## Открываем данные


```r
library(MASS)
data("Cushings")
```

Все ли правильно открылось?


```r
head(Cushings)
```

```
   Tetrahydrocortisone Pregnanetriol Type
a1                 3.1         11.70    a
a2                 3.0          1.30    a
a3                 1.9          0.10    a
a4                 3.8          0.04    a
a5                 4.1          1.10    a
a6                 1.9          0.40    a
```

```r
str(Cushings)
```

```
'data.frame':	27 obs. of  3 variables:
 $ Tetrahydrocortisone: num  3.1 3 1.9 3.8 4.1 1.9 8.3 3.8 3.9 7.8 ...
 $ Pregnanetriol      : num  11.7 1.3 0.1 0.04 1.1 0.4 1 0.2 0.6 1.2 ...
 $ Type               : Factor w/ 4 levels "a","b","c","u": 1 1 1 1 1 1 2 2 2 2 ...
```

---

## Знакомимся с данными

Есть ли пропущенные значения?


```r
colSums(is.na(Cushings))
```

```
Tetrahydrocortisone       Pregnanetriol                Type 
                  0                   0                   0 
```

&lt;br/&gt;

Каковы объемы выборки в каждой группе?


```r
table(Cushings$Type)
```

```

 a  b  c  u 
 6 10  5  6 
```

Обратите внимание, объемы выборок **маленькие**.

---

## Проверяем условия применимости...

1.Наблюдения независимы друг от друга?

- Да, независимы. Это случайная выборка.

&lt;br/&gt;

2.Выборки независимы друг от друга?

- Да, независимы. В группах разные люди (естественно, т.к. тип синдрома у человека может быть только какой-то один).

&lt;br/&gt;

3.Объем выборки достаточно велик или величины нормально распределены?

- Объем выборки мал


```r
table(Cushings$Type)
```

```

 a  b  c  u 
 6 10  5  6 
```

Нужно проверить форму распределения в обеих группах.

---

## Нормально ли распределены концентрации тетрагидрокортизона в группах?

![](04_hypothesis_testing_Part_2_files/figure-html/unnamed-chunk-16-1.png)&lt;!-- --&gt;

Удовлетворительно. При таких малых объемах выборки сложно ожидать лучшего. 

&lt;!-- Будем считать, что можно аппроксимировать концентрацию тетрагидрокортизона нормальным распределением. --&gt;

---

## Двухвыборочный t-тест в R: способ 1.

Сравним секрецию тетрагидрокортизона при помощи **двухвыборочного** t-теста.

```
t.test(x = значения_в_гр.1, 
       y = значения_в_гр.2)
```


```r
tt &lt;- t.test(x = Cushings$Tetrahydrocortisone[Cushings$Type == 'a'],
             y = Cushings$Tetrahydrocortisone[Cushings$Type == 'b'])
tt
```

```

	Welch Two Sample t-test

data:  Cushings$Tetrahydrocortisone[Cushings$Type == "a"] and Cushings$Tetrahydrocortisone[Cushings$Type == "b"]
t = -4.1, df = 11, p-value = 0.002
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 -7.988 -2.438
sample estimates:
mean of x mean of y 
    2.967     8.180 
```

---

## Опишем результаты


```

	Welch Two Sample t-test

data:  Cushings$Tetrahydrocortisone[Cushings$Type == "a"] and Cushings$Tetrahydrocortisone[Cushings$Type == "b"]
t = -4.1, df = 11, p-value = 0.002
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 -7.988 -2.438
sample estimates:
mean of x mean of y 
    2.967     8.180 
```

- Секреция тетрагидрокортизона значимо различается у пациентов с аденомой и двусторонней гиперплазией надпочечников ( `\(t_{10.69} = -4.15\)`, `\(p = &lt;0.05\)`)


&lt;br/&gt;

Можно указать в скобках не сравнение с `\(\alpha\)`, а само значение `\(p\)`:  
( `\(t_{10.69} = -4.15\)`, `\(p = 0.0017\)`).

Только не надо безумствовать и указывать слишком много знаков...


---

## График со средними и доверительными интервалами


```r
ggplot(data = Cushings[Cushings$Type %in% c('a', 'b'), ],
       aes(x = Type, y = Tetrahydrocortisone)) +
  stat_summary(fun.data = mean_cl_normal)
```

![](04_hypothesis_testing_Part_2_files/figure-html/unnamed-chunk-19-1.png)&lt;!-- --&gt;


---


class: middle, center, inverse

# Пермутационные методы оценки статистической значимости

&lt;p style="text-align:right"&gt;

- Друг мой, - отвечал Диоталлеви, - ты никогда ничего не поймешь. Да, это правда, что Тора -- я имею в виду, разумеется, видимую Тору - есть лишь одна из перестановок- пермутаций букв, составляющих вековечную Тору, какою создал ее Творец и какой ее дал Адаму. 

Умберто Эко "Маятник Фуко"

&lt;/p&gt;

---
## Тестирование простейшей гипотезы

Создадим две выборки из популяций с нормальным распределением признака, с заведомо отличающимися средними значениями.


```r
set.seed(12345)

male &lt;- rnorm(100, 130, 5)
female &lt;- rnorm(100, 129,5)
```

---

## Частотное распределение этих двух выборок выглядит так:

![](04_hypothesis_testing_Part_2_files/figure-html/unnamed-chunk-21-1.png)&lt;!-- --&gt;


---
## Сравним две выборки с помощью t-критерия Стьюдента

Cтатистика, которая используется в t-критерии

`\(t= \frac {\bar{x_1}-\bar{x_2}} {SE_{x_1, x_2}}\)`


Результаты


```r
t &lt;- t.test(male, female)
t
```

```

	Welch Two Sample t-test

data:  male and female
t = 2.7, df = 196, p-value = 0.009
alternative hypothesis: true difference in means is not equal to 0
95 percent confidence interval:
 0.5157 3.4839
sample estimates:
mean of x mean of y 
    131.2     129.2 
```

Что означает выражение p-value = 0.0085?

---
## Пермутационный подход к тестированию

Если две сравниваемые выборки взяты из одной совокупности (справедлива `\(H_0\)`), то обмен элементами между ними ничего не изменит. Степень различия между выборками (значение статистики) останется более или менее тем же самым.

&lt;p class="forceBreak"&gt;

&lt;/p&gt;

**Пермутации --- это перестановки.**

Полное количество пермутаций (при равном количестве объектов в двух группах) будет вычисляться по следующей формуле:

`$$K= \frac{(2n)!}{(2!(n!)^2)}$$`

При большом объеме выборок это огромное число!

В таких случаях используют метод Монте-Карло.

---
## Пермутационный метод вручную

Применим этот метод (на очень примитивном уровне) к нашим двум выборкам, описывающим размеры мальчиков и девочек (векторы male и female).


```r
head(male)
```

```
[1] 132.9 133.5 129.5 127.7 133.0 120.9
```

```r
head(female)
```

```
[1] 130.1 123.2 131.1 122.4 129.7 126.3
```

---
## Пермутационный метод вручную

Введем статистику:

`$$t= \frac {\bar{x_1} - \bar{x_2} }{ \sqrt {SE_1^2+SE_2^2}}$$`
На самом деле, статистика может быть любой. Эту форму статистики мы будем использовать для сравннеия с результатми применения t-критерия

Вычислим значение этой статистики при сравнении векторов male и female:


```r
SE_m &lt;- sd(male) / sqrt(length(male))
SE_f &lt;- sd(female) / sqrt(length(female))
t_initial &lt;- (mean(male) - mean(female))/sqrt(SE_m^2 + SE_f^2)
```

Полученное значение t = 2.6574.

---
## Пермутационный метод вручную

При пермутациях мы должны поменять местами, например, male[10] = 125.4034 и female[20] = 128.6549. А еще лучше поменять случайное количество элементов одной выборки на случайное количество элементов из другой выборки.


```r
f &lt;- female
m &lt;- male
num_perm &lt;- sample(1:100, 1)
order_m &lt;- sample(1:100, num_perm)
order_f &lt;- sample(1:100, num_perm)
f[order_f] &lt;- male[order_f]
m[order_m] &lt;- female[order_f]
SE_m &lt;- sd(m) / sqrt(length(m))
SE_f &lt;- sd(f) / sqrt(length(f))
t_p &lt;- (mean(m) - mean(f)) / sqrt(SE_m^2 + SE_f^2)
```

После этой пермутации у нас получилось значение `\(t_{perm}\)` = -2.3317, а исходное значение было t = 2.6574.

---
## Пермутационный метод вручную

Теперь нужно провести процедуру пермутации много раз и получить распределение значений статистики `\(t_{perm}\)`.


```r
Nperm = 10000
tperm &lt;- rep(NA, Nperm)

set.seed(12345)
for (i in 1:(Nperm-1)) 
  {
  BOX &lt;- c(male ,female)
  ord &lt;- sample(1:200, 200)
  f &lt;- BOX[ord[1:100]]
  m &lt;- BOX[ord[101:200]]
  SE_m &lt;- sd(m) / sqrt(length(m))
  SE_f &lt;- sd(f) / sqrt(length(f))
  tperm[i]=(mean(m) - mean(f))/sqrt(SE_m^2 + SE_f^2)
}

head(tperm)
```

```
[1] -0.5083 -0.4202 -2.2400 -0.7809  0.9006 -1.1521
```

---

## Пермутационный метод вручную

Посмотрим в конец этого вектора.


```r
tail(tperm)
```

```
[1] -0.49853  1.63438 -0.78635 -0.02491  1.02924       NA
```

Последнее 10000-е значение не заполнено!

В него надо вписать исходное, полученное до пермутаций, значение t = 2.6574. Это необходимо, так как мы тестируем гипотезу о принадлежности этого значения случайному распределению.



```r
tperm [Nperm] &lt;- t_initial
```

---
## Пермутационный метод вручную

Построим частотное распределение пермутированных значений статистики `\(t_{perm}\)`.

![](04_hypothesis_testing_Part_2_files/figure-html/unnamed-chunk-29-1.png)&lt;!-- --&gt;

Это то, что порождается случайными перестановками. То есть это то, что было бы при спрведливости нулевой гипотезы.

---
## Пермутационный метод вручную

Рассчитаем величину уровня значимости `\(p_{perm}= \frac{N_{t_{perm} \geq t}}{N_{perm}}\)`:


```r
p_perm &lt;- length(tperm[tperm &gt;= t_initial] | tperm[tperm 
                                                   &lt;= -t_initial]) / Nperm
```

Мы получили уровень значимости `\(p_{perm}\)` = 0.0049.

Сравним его с уровнем значимости, вычисленным с помощью параметрического t-критерия p = 0.0085.

Они оба близки и оба выявляют значимые различия!




---

## Take-home messages

- По центральной предельной теореме выборочные средние нормально распределены `$$\bar X \sim N (\mu, \sigma / \sqrt{n})$$`.
- Доверительный интервал к среднему значению можно построить из нормального распределения, если известна `\(\sigma\)` в генеральной совокупности, или из `\(t\)`-распределения, если она не известна.
- При тестировании нулевой гипотезы оценивают вероятность получения данного или более экстремального значения тестовой статистики при условии, что `\(H_0\)` справедлива. Если эта вероятность меньше выбранного критического уровня значимости, то нулевую гипотезу отвергают.
- Для сравнения выборочных средних лучше использовать t-критерий в модификации Уэлча, который учитывает, что дисперсии в группах могут быть разными.
- Средние в независимых выборках нужно сравнивать двухвыборочным t-тестом.
- Если выборки зависимы — нужно это учесть, поэтому для сравнения средних используется парный t-тест.

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="assets/macros.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "googlecode",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>
<!-- https://github.com/fnaufel/xaringan-smartify-->
<script type="text/javascript">
  smartify();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
