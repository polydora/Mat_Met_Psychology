---
title: "Анализ объема легких у курящих и некурящих людей"
author: "Авакян Кристина"
date: "2026.01.21"
output: word_document
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
               fig.width = 6, fig.height = 4, out.width = "80%", out.height = "80%")

# Настройка размера шрифта для таблиц в Word
options(knitr.table.format = "pandoc")
```

# Введение

Объем легких является важным показателем функции дыхательной системы человека. На него могут влиять различные факторы, включая возраст, пол, рост и курение. Курение, в частности, является известным фактором риска, который может негативно влиять на легочную функцию.

Данные для настоящего исследования были взяты из работы Tager et al. (1979), в которой изучалось влияние курения родителей на функцию легких у детей. Исходные данные были опубликованы в работе Rosner (1990) и доступны по адресу: http://www.statsci.org/data/general/fev.html.

Целью настоящего исследования является ответ на два основных вопроса:

1. Различается ли объем легких у курящих и некурящих людей?
2. Как зависит объем легких от возраста у курящих и некурящих людей?

# Материалы и методы

## Описание данных

В анализе использовались данные из файла `fev.xls`, лист "tidy_data". Датасет содержит следующие переменные:

- **Age** - Возраст (годы)
- **FEV** - Объем легких при выдохе (литры, forced expiratory volume)
- **Height** - Рост (дюймы)
- **Sex** - Пол (Male или Female)
- **Smoker** - Статус курения (Non - некурящие, Current - курящие)

```{r load_data, echo=FALSE, message=FALSE, warning=FALSE}
# ==================================================================
# Загрузка и подготовка данных
# ==================================================================

# Загружаем необходимые пакеты
library(readxl)
library(dplyr)
library(ggplot2)
library(knitr)
library(broom)
library(tidyr)

# ==================================================================
# Читаем данные из файла fev.xls
# ==================================================================

fev <- read_excel("Data/fev.xls",
                  sheet = "tidy_data",
                  col_names = TRUE,
                  na = "NA",
                  skip = 1)

# ==================================================================
# Проверка структуры данных
# ==================================================================

# Смотрим имена переменных
names(fev)

# Проверяем структуру датафрейма
str(fev)

# Первые строки данных
head(fev)

# ==================================================================
# Проверка пропущенных значений
# ==================================================================

# Подсчитываем количество пропущенных значений по переменным
colSums(is.na(fev))

# Общее количество строк с пропущенными значениями
sum(!complete.cases(fev))

# ==================================================================
# Обработка данных
# ==================================================================

# Преобразуем переменные Sex и Smoker в факторы
fev <- fev %>%
  mutate(Sex = factor(Sex),
         Smoker = factor(Smoker))

# Удаляем строки с пропущенными значениями
fev <- fev %>%
  filter(complete.cases(.))

# Проверяем структуру после обработки
str(fev)
summary(fev)
```

## Методы статистического анализа

Для ответа на первый вопрос исследования (различается ли объем легких у курящих и некурящих людей) использовался двухвыборочный t-критерий. Перед применением теста была проверена нормальность распределения FEV в каждой группе.

Для ответа на второй вопрос (зависимость объема легких от возраста) была построена линейная регрессионная модель. Модель описывается следующим уравнением:

$$
FEV = \beta_0 + \beta_1 \cdot Age + \epsilon
$$

где $\beta_0$ - свободный член (intercept), $\beta_1$ - коэффициент наклона (slope), $\epsilon$ - случайная ошибка.

Для каждой группы (курящие и некурящие) была построена отдельная модель регрессии, что позволило сравнить характер зависимости FEV от возраста в этих группах.

# Результаты

## Описательная статистика

```{r descriptive_stats, echo=FALSE, message=FALSE, warning=FALSE}
# ==================================================================
# Описательная статистика по группам
# ==================================================================

# Вычисляем описательную статистику по группам (курящие/некурящие)
desc_stats <- fev %>%
  group_by(Smoker) %>%
  summarise(
    n = n(),
    Mean = mean(FEV, na.rm = TRUE),
    SD = sd(FEV, na.rm = TRUE),
    Median = median(FEV, na.rm = TRUE),
    Min = min(FEV, na.rm = TRUE),
    Max = max(FEV, na.rm = TRUE),
    Q1 = quantile(FEV, probs = 0.25, na.rm = TRUE),
    Q3 = quantile(FEV, probs = 0.75, na.rm = TRUE),
    .groups = "drop"
  )

# Округляем значения для таблицы
desc_stats_table <- desc_stats %>%
  mutate(
    Mean = round(Mean, 2),
    SD = round(SD, 2),
    Median = round(Median, 2),
    Min = round(Min, 2),
    Max = round(Max, 2),
    Q1 = round(Q1, 2),
    Q3 = round(Q3, 2)
  )

# Переименовываем столбцы для читаемости
colnames(desc_stats_table) <- c("Группа", "n", "Среднее", "Ст. откл.", 
                                 "Медиана", "Мин", "Макс", "Q1", "Q3")

# Выводим таблицу
kable(desc_stats_table, caption = "Таблица 1. Описательная статистика объема легких (FEV, л) по группам", format = "pandoc")
```

После обработки данных и удаления пропущенных значений в анализе использовалось `r nrow(fev)` наблюдений. Из них `r sum(fev$Smoker == "Non")` человек были некурящими, а `r sum(fev$Smoker == "Current")` - курящими.

## Ответ на вопрос 1: Различия FEV между курящими и некурящими

```{r question1_age_distribution, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Рисунок 1. Распределение возрастов в группах курящих и некурящих"}
# ==================================================================
# Анализ распределения возрастов в группах
# ==================================================================

# Проверяем распределение возрастов в группах
age_distribution <- fev %>%
  group_by(Smoker) %>%
  summarise(
    n = n(),
    mean_age = round(mean(Age), 1),
    median_age = round(median(Age), 1),
    min_age = min(Age),
    max_age = max(Age),
    sd_age = round(sd(Age), 1),
    .groups = "drop"
  )

# Создаем график распределения возрастов
plot_age_distribution <- fev %>%
  ggplot(aes(x = Age, fill = Smoker)) +
  geom_histogram(bins = 20, alpha = 0.7, position = "identity", color = "black") +
  theme_bw() +
  labs(
    title = "Распределение возрастов в группах",
    subtitle = "Важно: различия в возрасте могут влиять на сравнение FEV",
    x = "Возраст (годы)",
    y = "Количество наблюдений",
    fill = "Группа"
  ) +
  scale_fill_manual(values = c("Current" = "#ff9999", "Non" = "#99ccff"),
                    labels = c("Current" = "Курящие", "Non" = "Некурящие")) +
  facet_wrap(~Smoker, ncol = 1, labeller = labeller(Smoker = c("Current" = "Курящие", "Non" = "Некурящие")))

# Показываем график
plot_age_distribution

# Выводим таблицу распределения возрастов
kable(age_distribution, caption = "Таблица 1a. Распределение возрастов в группах", format = "pandoc")
```

```{r question1_analysis, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Рисунок 2. Сравнение объема легких (FEV, л) между курящими и некурящими с учетом возраста"}
# ==================================================================
# Визуализация различий FEV между группами с учетом возраста
# ==================================================================

# Создаем график FEV в зависимости от возраста для обеих групп
plot_fev_age_comparison <- fev %>%
  ggplot(aes(x = Age, y = FEV, color = Smoker, fill = Smoker)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = TRUE, linewidth = 1) +
  theme_bw() +
  labs(
    title = "Сравнение объема легких между курящими и некурящими",
    subtitle = "С учетом возраста. Линии регрессии показывают зависимость FEV от возраста",
    x = "Возраст (годы)",
    y = "Объем легких (FEV, л)",
    color = "Группа",
    fill = "Группа"
  ) +
  scale_color_manual(values = c("Current" = "#ff6666", "Non" = "#6699ff"),
                    labels = c("Current" = "Курящие", "Non" = "Некурящие")) +
  scale_fill_manual(values = c("Current" = "#ff6666", "Non" = "#6699ff"),
                    labels = c("Current" = "Курящие", "Non" = "Некурящие"))

# Показываем график
plot_fev_age_comparison

# Сохраняем график (закомментировано)
# ggsave("Pictures/Avakian_FEV_Age_Comparison.jpg", plot = plot_fev_age_comparison, 
#        width = 10, height = 6, dpi = 300)
```

```{r question1_test, echo=FALSE, message=FALSE, warning=FALSE}
# ==================================================================
# Статистический анализ с учетом возраста
# ==================================================================

# Проверяем средний возраст в группах
age_non <- fev %>% filter(Smoker == "Non") %>% pull(Age)
age_current <- fev %>% filter(Smoker == "Current") %>% pull(Age)
mean_age_non <- mean(age_non)
mean_age_current <- mean(age_current)
sd_age_non <- sd(age_non)
sd_age_current <- sd(age_current)

# Разделяем данные по группам
fev_non <- fev %>% filter(Smoker == "Non") %>% pull(FEV)
fev_current <- fev %>% filter(Smoker == "Current") %>% pull(FEV)

# Вычисляем средние FEV
mean_non <- mean(fev_non)
mean_current <- mean(fev_current)
diff_means <- mean_non - mean_current

# ==================================================================
# Анализ ковариации (ANCOVA) для учета возраста
# ==================================================================

# Строим модель ANCOVA: FEV ~ Age + Smoker
model_ancova <- lm(FEV ~ Age + Smoker, data = fev)
summary_ancova <- summary(model_ancova)
anova_ancova <- anova(model_ancova)

# Извлекаем скорректированные средние (adjusted means) для каждой группы
# при среднем значении возраста
mean_age_overall <- mean(fev$Age)

# Предсказанные значения при среднем возрасте для каждой группы
fev_non_adj <- predict(model_ancova, newdata = data.frame(Age = mean_age_overall, Smoker = "Non"))
fev_current_adj <- predict(model_ancova, newdata = data.frame(Age = mean_age_overall, Smoker = "Current"))
diff_means_adj <- fev_non_adj - fev_current_adj

# ==================================================================
# Сравнение по возрастным категориям
# ==================================================================

# Создаем возрастные категории
fev_age_cat <- fev %>%
  mutate(
    Age_category = case_when(
      Age < 12 ~ "8-11 лет",
      Age < 15 ~ "12-14 лет",
      Age < 18 ~ "15-17 лет",
      TRUE ~ "18+ лет"
    ),
    Age_category = factor(Age_category, levels = c("8-11 лет", "12-14 лет", "15-17 лет", "18+ лет"))
  )

# Сравнение по возрастным категориям
comparison_by_age <- fev_age_cat %>%
  group_by(Age_category, Smoker) %>%
  summarise(
    n = n(),
    mean_FEV = round(mean(FEV), 2),
    sd_FEV = round(sd(FEV), 2),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = Smoker, values_from = c(n, mean_FEV, sd_FEV), 
              names_sep = "_") %>%
  mutate(
    diff = round(mean_FEV_Non - mean_FEV_Current, 2)
  )

# Формируем таблицу сравнения по возрастным категориям
kable(comparison_by_age, 
      col.names = c("Возрастная категория", "n (Non)", "n (Current)", 
                    "Среднее FEV (Non)", "Среднее FEV (Current)",
                    "SD (Non)", "SD (Current)", "Разница"),
      caption = "Таблица 2. Сравнение FEV между группами по возрастным категориям", format = "pandoc")

# ==================================================================
# Результаты ANCOVA
# ==================================================================

# Формируем таблицу результатов ANCOVA
ancova_results <- data.frame(
  Параметр = c("Среднее FEV (некурящие, нескорректированное)", 
               "Среднее FEV (курящие, нескорректированное)",
               "Разница (нескорректированная)",
               "Среднее FEV (некурящие, скорректированное по возрасту)",
               "Среднее FEV (курящие, скорректированное по возрасту)",
               "Разница (скорректированная по возрасту)",
               "Эффект возраста (p-value)",
               "Эффект курения (p-value, скорректированный)"),
  Значение = c(
    round(mean_non, 3),
    round(mean_current, 3),
    round(diff_means, 3),
    round(fev_non_adj, 3),
    round(fev_current_adj, 3),
    round(diff_means_adj, 3),
    format(anova_ancova$`Pr(>F)`[1], scientific = TRUE, digits = 3),
    format(anova_ancova$`Pr(>F)`[2], scientific = TRUE, digits = 3)
  )
)

# Выводим таблицу результатов ANCOVA
kable(ancova_results, caption = "Таблица 3. Результаты анализа ковариации (ANCOVA) для сравнения FEV с учетом возраста", format = "pandoc")

# Извлекаем p-value для использования в тексте
p_value_age_effect <- anova_ancova$`Pr(>F)`[1]
p_value_smoker_effect <- anova_ancova$`Pr(>F)`[2]
```

**Результаты статистического анализа:**

При сравнении без учета возраста средний объем легких у некурящих (Non) составил `r round(mean_non, 2)` л, а у курящих (Current) - `r round(mean_current, 2)` л. Однако средний возраст в группе некурящих составил `r round(mean_age_non, 1)` лет (SD = `r round(sd_age_non, 1)`), а в группе курящих - `r round(mean_age_current, 1)` лет (SD = `r round(sd_age_current, 1)`). Это существенное различие в возрасте объясняет, почему нескорректированное сравнение показывает более высокий FEV у курящих: в этой группе больше взрослых людей с естественно большим объемом легких.

Для корректного сравнения был проведен анализ ковариации (ANCOVA), который учитывает влияние возраста. После корректировки на возраст при среднем значении возраста (`r round(mean_age_overall, 1)` лет), скорректированное среднее FEV у некурящих составило `r round(fev_non_adj, 2)` л, а у курящих - `r round(fev_current_adj, 2)` л. Скорректированная разница составила `r round(diff_means_adj, 2)` л.

ANCOVA показал, что возраст является статистически значимым фактором (p < `r ifelse(p_value_age_effect < 0.001, "0.001", format(p_value_age_effect, digits = 3))`). После учета возраста эффект курения `r ifelse(p_value_smoker_effect < 0.05, "является статистически значимым", "не является статистически значимым")` (p = `r format(p_value_smoker_effect, digits = 3)`). `r ifelse(p_value_smoker_effect < 0.05 && diff_means_adj > 0, "Это означает, что после учета возраста объем легких у некурящих людей статистически значимо выше, чем у курящих.", ifelse(p_value_smoker_effect < 0.05 && diff_means_adj < 0, "Это означает, что после учета возраста объем легких у курящих людей статистически значимо выше, чем у некурящих.", "После учета возраста статистически значимых различий в объеме легких между группами не обнаружено."))`

Сравнение по возрастным категориям (см. Таблицу 2) также показывает, что различия между группами неоднородны в разных возрастных диапазонах, что подтверждает важность учета возраста при анализе.

## Ответ на вопрос 2: Линейная регрессия FEV от Age

```{r question2_regression, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Рисунок 2. Зависимость объема легких (FEV, л) от возраста у курящих и некурящих людей"}
# ==================================================================
# Построение линейных регрессионных моделей
# ==================================================================

# Разделяем данные на группы
fev_non_data <- fev %>% filter(Smoker == "Non")
fev_current_data <- fev %>% filter(Smoker == "Current")

# Строим модели регрессии для каждой группы
model_non <- lm(FEV ~ Age, data = fev_non_data)
model_current <- lm(FEV ~ Age, data = fev_current_data)

# Выводим результаты моделей
summary(model_non)
summary(model_current)

# Создаем scatter plot с линиями регрессии
plot_regression <- fev %>%
  ggplot(aes(x = Age, y = FEV, color = Smoker)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = TRUE, linewidth = 1) +
  theme_bw() +
  labs(
    title = "Зависимость объема легких от возраста",
    subtitle = "Линии регрессии для курящих и некурящих людей",
    x = "Возраст (годы)",
    y = "Объем легких (FEV, л)",
    color = "Группа"
  ) +
  scale_color_manual(values = c("Current" = "#ff6666", "Non" = "#6699ff"),
                    labels = c("Current" = "Курящие", "Non" = "Некурящие")) +
  theme(legend.position = "right")

# Показываем график
plot_regression

# Сохраняем график (закомментировано)
# ggsave("Pictures/Avakian_FEV_Age_Regression.jpg", plot = plot_regression,
#        width = 10, height = 6, dpi = 300)
```

```{r question2_table, echo=FALSE, message=FALSE, warning=FALSE}
# ==================================================================
# Таблица коэффициентов регрессии
# ==================================================================

# Извлекаем коэффициенты для некурящих
coef_non <- tidy(model_non, conf.int = TRUE) %>%
  mutate(Группа = "Некурящие") %>%
  select(Группа, term, estimate, conf.low, conf.high, p.value)

# Извлекаем коэффициенты для курящих
coef_current <- tidy(model_current, conf.int = TRUE) %>%
  mutate(Группа = "Курящие") %>%
  select(Группа, term, estimate, conf.low, conf.high, p.value)

# Объединяем результаты
coef_table <- bind_rows(coef_non, coef_current) %>%
  mutate(
    Коэффициент = case_when(
      term == "(Intercept)" ~ "Свободный член (β₀)",
      term == "Age" ~ "Возраст (β₁)"
    ),
    Оценка = round(estimate, 3),
    `95% ДИ нижняя` = round(conf.low, 3),
    `95% ДИ верхняя` = round(conf.high, 3),
    `p-value` = format(p.value, scientific = TRUE, digits = 3)
  ) %>%
  select(Группа, Коэффициент, Оценка, `95% ДИ нижняя`, `95% ДИ верхняя`, `p-value`)

# Выводим таблицу
kable(coef_table, caption = "Таблица 3. Коэффициенты линейной регрессии FEV от Age для курящих и некурящих", format = "pandoc")

# Извлекаем p-value из anova для использования в тексте
anova_non <- anova(model_non)
anova_current <- anova(model_current)
p_value_model_non <- anova_non$`Pr(>F)`[1]
p_value_model_current <- anova_current$`Pr(>F)`[1]

# Извлекаем p-value для коэффициента Age
p_value_age_non <- summary(model_non)$coefficients[2, 4]
p_value_age_current <- summary(model_current)$coefficients[2, 4]

# Создаем таблицу с характеристиками моделей
model_summary <- data.frame(
  Группа = c("Некурящие", "Курящие"),
  `R²` = c(round(summary(model_non)$r.squared, 3), 
           round(summary(model_current)$r.squared, 3)),
  `Скорректированный R²` = c(round(summary(model_non)$adj.r.squared, 3),
                              round(summary(model_current)$adj.r.squared, 3)),
  `F-статистика` = c(round(summary(model_non)$fstatistic[1], 2),
                     round(summary(model_current)$fstatistic[1], 2)),
  `p-value модели` = c(format(p_value_model_non, scientific = TRUE, digits = 3),
                       format(p_value_model_current, scientific = TRUE, digits = 3))
)

# Выводим таблицу характеристик моделей
kable(model_summary, caption = "Таблица 4. Характеристики регрессионных моделей", format = "pandoc")
```

**Результаты регрессионного анализа:**

Для некурящих людей уравнение регрессии имеет вид: FEV = `r round(coef(model_non)[1], 3)` + `r round(coef(model_non)[2], 3)` × Age. Модель объясняет `r round(summary(model_non)$r.squared * 100, 1)`% вариации объема легких (R² = `r round(summary(model_non)$r.squared, 3)`, p < `r ifelse(p_value_model_non < 0.001, "0.001", format(p_value_model_non, digits = 3))`). Коэффициент при Age (`r round(coef(model_non)[2], 3)`) статистически значим (p < `r ifelse(p_value_age_non < 0.001, "0.001", format(p_value_age_non, digits = 3))`), что указывает на положительную связь между возрастом и объемом легких у некурящих.

Для курящих людей уравнение регрессии: FEV = `r round(coef(model_current)[1], 3)` + `r round(coef(model_current)[2], 3)` × Age. Модель объясняет `r round(summary(model_current)$r.squared * 100, 1)`% вариации (R² = `r round(summary(model_current)$r.squared, 3)`, p < `r ifelse(p_value_model_current < 0.001, "0.001", format(p_value_model_current, digits = 3))`). Коэффициент при Age (`r round(coef(model_current)[2], 3)`) также статистически значим (p < `r ifelse(p_value_age_current < 0.001, "0.001", format(p_value_age_current, digits = 3))`).

Сравнение моделей показывает, что у некурящих людей объем легких увеличивается с возрастом быстрее (`r round(coef(model_non)[2], 3)` л/год), чем у курящих (`r round(coef(model_current)[2], 3)` л/год). Это может указывать на негативное влияние курения на развитие легочной функции с возрастом.

# Обсуждение

Результаты настоящего исследования показывают, что курение оказывает статистически значимое влияние на объем легких. У некурящих людей средний объем легких выше, чем у курящих, что согласуется с известными данными о негативном влиянии курения на функцию дыхательной системы.

Регрессионный анализ выявил положительную связь между возрастом и объемом легких в обеих группах, что соответствует нормальному развитию легочной функции в детском и подростковом возрасте. Однако скорость увеличения объема легких с возрастом была выше у некурящих людей по сравнению с курящими. Это может указывать на то, что курение не только снижает текущий объем легких, но и замедляет его нормальное развитие с возрастом.

Полученные результаты подчеркивают важность отказа от курения для поддержания оптимальной функции легких, особенно в период роста и развития организма.

# Список литературы

1. Tager, I. B., Weiss, S. T., Rosner, B., and Speizer, F. E. (1979). Effect of parental cigarette smoking on pulmonary function in children. *American Journal of Epidemiology*, 110, 15-26.

2. Rosner, B. (1990). *Fundamentals of Biostatistics*, 3rd Edition. PWS-Kent, Boston, Massachusetts.
