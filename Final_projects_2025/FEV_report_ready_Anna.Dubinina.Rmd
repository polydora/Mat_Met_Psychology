---
title: "FEV и курение. Отчет (RMarkdown)"
author: "Анна Дубинина"
date: "`r format(Sys.Date(), '%d.%m.%Y')`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)

library(readxl)
library(dplyr)
library(tidyr)
library(ggplot2)
library(broom)
library(knitr)
```

# Введение

FEV (forced expiratory volume) — объём воздуха (в литрах), который человек может форсированно выдохнуть за короткое время; это один из базовых показателей функции лёгких. Датасет используется в учебных задачах биостатистики и связан с классическими работами по влиянию курения на дыхательную систему (Tager et al., 1979; Rosner, 1990).

Цели:  
1) проверить, отличается ли FEV у курящих и некурящих;  
2) описать зависимость FEV от возраста у курящих и некурящих с помощью линейной регрессии.

# Материалы и методика

Переменные: Age (лет), FEV (л), Height (дюймы), Sex (Male/Female), Smoker (Non/Current).

## Импорт и подготовка данных

```{r import}
fev <- readxl::read_excel("fev.xls", sheet = "tidy_data", skip = 1)

fev <- fev %>%
  mutate(
    Smoker = na_if(Smoker, "NA"),
    Age    = as.numeric(Age),
    FEV    = as.numeric(FEV),
    Height = as.numeric(Height),
    Sex    = factor(Sex),
    Smoker = factor(Smoker)
  ) %>%
  drop_na(Age, FEV, Height, Sex, Smoker)

table(fev$Smoker)
```

# фиксирую порядок уровней  
fev <- fev %>% mutate(Smoker = factor(Smoker, levels = c("Non", "Current")))

str(fev)
table(fev$Smoker)
```

## Статистический план

- Для сравнения групп: Welch t-test (независимые выборки).  
- Для описания зависимости FEV от возраста: линейная модель с взаимодействием Age * Smoker.  
- Дополнительно: модель с поправкой на рост и пол.

# Результаты

## Описательная статистика (таблица)

```{r table1}
tab1 <- fev %>%
  group_by(Smoker) %>%
  summarise(
    n = n(),
    FEV_mean = mean(FEV),
    FEV_sd = sd(FEV),
    Age_mean = mean(Age),
    Height_mean = mean(Height),
    .groups = "drop"
  )

kable(tab1, digits = 3, caption = "Описательные статистики по группам курения")
```

## Отличается ли FEV у курящих и некурящих?

```{r ttest}
tt <- t.test(FEV ~ Smoker, data = fev)
tt
```

## Линейная регрессия: зависимость FEV от возраста у курящих и некурящих

### Модель 1: только возраст, курение и их взаимодействие

```{r model1}
m1 <- lm(FEV ~ Age * Smoker, data = fev)
summary(m1)

kable(tidy(m1), digits = 4, caption = "Модель 1: FEV ~ Age * Smoker")
```

### Модель 2: с поправкой на рост и пол

```{r model2}
fev <- fev %>% mutate(Age_c = Age - mean(Age))

m2 <- lm(FEV ~ Age_c * Smoker + Height + Sex, data = fev)
summary(m2)

kable(tidy(m2), digits = 4, caption = "Модель 2: FEV ~ Age_c * Smoker + Height + Sex")
```

## Рисунок

```{r plot1}
ggplot(fev, aes(x = Age, y = FEV, color = Smoker)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE) +
  labs(x = "Возраст (лет)", y = "FEV (л)") +
  theme_minimal()
```

## Формула

Для примера формулы (как элемент отчёта) приведём 95% доверительный интервал среднего:

$$
\bar{x} \pm t_{0.975,\,df} \cdot \frac{s}{\sqrt{n}}
$$

# Обсуждение

При прямом сравнении курящих и некурящих участников наблюдается различие средних значений FEV: у курящих объём форсированного выдоха в среднем выше. Однако такой результат не следует интерпретировать как положительный эффект курения. Это различие, вероятнее всего, связано с тем, что курящие участники в выборке в среднем старше и выше ростом, а оба этих фактора тесно связаны с объёмом лёгких и оказывают на него выраженное физиологическое влияние.

Результаты линейной регрессионной модели с взаимодействием возраста и курения показывают, что FEV увеличивается с возрастом как у курящих, так и у некурящих, что соответствует известным закономерностям роста и развития лёгких. При этом наличие члена взаимодействия позволяет проверить, отличается ли характер возрастной динамики FEV в группах курения. Полученные оценки не указывают на выраженное усиление прироста FEV у курящих по сравнению с некурящими после учёта возраста, что подтверждает предположение о ведущей роли возрастных и антропометрических факторов.

После включения в модель роста (Height) и пола (Sex) вклад курения в объяснение вариабельности FEV дополнительно снижается. Рост оказывается одним из наиболее сильных предикторов объёма лёгких, а пол также вносит статистически значимый вклад. В этой скорректированной модели эффект курения становится менее выраженным, что свидетельствует о том, что наблюдаемые различия между группами в значительной степени обусловлены структурой выборки, а не прямым влиянием курения на функцию лёгких.

Таким образом, результаты анализа показывают, что без учёта возраста и роста сравнение FEV между курящими и некурящими может приводить к вводящим в заблуждение выводам. Использование многофакторной линейной регрессии позволяет более корректно интерпретировать данные и отделить потенциальный эффект курения от влияния физиологических характеристик организма.

# Литература

1. Tager, I. B., Weiss, S. T., Rosner, B., & Speizer, F. E. (1979). *Effect of parental cigarette smoking on pulmonary function in children*. American Journal of Epidemiology, 110, 15–26.  
2. Rosner, B. (1990). *Fundamentals of Biostatistics* (3rd ed.). PWS-Kent, Boston, MA.
