# Домашнее задание 7 - Множественная линейная регрессия (Задача про крестиков и ноликов)
# Авакян Кристина
# Группа: ББ5А23/10

# Вариант 1. Учет обилия крестиков и ноликов, мигрирующих при разной температуре воздуха
#            Данные: Data/Var1.csv
#
# ЗАДАНИЕ:
# 1. Построить линейную модель, описывающую зависимость численности крестиков 
#    от численности ноликов и от температуры воздуха.
# 2. Провести диагностику полученной модели. Есть ли какие-нибудь проблемы в построенной модели?
# 3. Визуализировать зависимость численности крестиков от двух изученных предикторов.

# ==================================================================
# 1. Загрузка и подготовка данных
# ==================================================================

# Загружаем пакеты
library(dplyr)
library(ggplot2)
library(car)
library(gridExtra)
library(lmtest)  # для теста Бройша-Пагана (bptest)

# Читаем данные
migration_data <- read.csv("Data/Var1.csv", sep = ";", header = TRUE)

# Смотрим структуру данных
str(migration_data)
head(migration_data)

# Подсчитываем количество крестиков (x) и ноликов (0) в каждой строке Spec
# Используем stringr для подсчета символов
# install.packages("stringr") # при необходимости
library(stringr)

migration_data %>%
  mutate(X_count = str_count(Spec, "x"),  # количество крестиков
         O_count = str_count(Spec, "0"),  # количество ноликов
         Temp = as.numeric(Temp)) %>%     # температура как числовая переменная
  select(Day, Temp, X_count, O_count) -> migration

# Проверяем структуру подготовленных данных
str(migration)
head(migration)
summary(migration)

# Проверяем наличие пропущенных значений
colSums(is.na(migration))

# ==================================================================
# 2. Визуальная разведка данных
# ==================================================================

# Строим диаграммы Кливленда для выявления выбросов
gg_dot <- ggplot(migration, aes(y = 1:nrow(migration))) + 
  geom_point() + 
  ylab('Порядковый номер наблюдения')

# Формируем 3 графика
Pl1 <- gg_dot + aes(x = X_count) + xlab("Количество крестиков")
Pl2 <- gg_dot + aes(x = O_count) + xlab("Количество ноликов")
Pl3 <- gg_dot + aes(x = Temp) + xlab("Температура")

# Загружаем паект cowplot
library(cowplot)
plot_grid(Pl1, Pl2, Pl3, ncol = 3)

# Строим матрицу диаграмм рассеяния как scatter plot (pairs plot)
pairs(migration[, c("X_count", "O_count", "Temp")], main = "Матрица диаграмм рассеяния")

# Корреляционная матрица
round(cor(migration[, c("X_count", "O_count", "Temp")]), 3)

# Графики зависимостей
ggplot(migration, aes(x = O_count, y = X_count)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  labs(title = "Зависимость количества крестиков от ноликов",
       x = "Количество ноликов", y = "Количество крестиков") +
  theme_minimal()

ggplot(migration, aes(x = Temp, y = X_count)) +
  geom_point() +
  geom_smooth(method = "lm", se = TRUE) +
  labs(title = "Зависимость количества крестиков от температуры",
       x = "Температура (°C)", y = "Количество крестиков") +
  theme_minimal()

# ВЫВОД:
# Между X_count и O_count (r = 0.938) - сильная положительная корреляция.
# Количество крестиков тесно связано с количеством ноликов.
# Между X_count и Temp (r = 0.018) - практически отсутствует линейная связь.
# Между O_count и Temp (r = -0.182) - слабая отрицательная корреляция.
# При росте температуры количество ноликов слегка снижается

# ==================================================================
# 3. Построение множественной линейной регрессии
# ==================================================================

# Выбираем модель: X_count ~ O_count + Temp
# X_count_i = b_0 + b_1 * O_count_i + b_2 * Temp_i + e_i

model <- lm(X_count ~ O_count + Temp, data = migration)

# Вывод результатов модели
summary(model)

# ANOVA таблица
anova(model)

# Доверительные интервалы для коэффициентов
confint(model)

# ПОЛУЧЕННЫЕ РЕЗУЛЬТАТЫ:
#
# Качество модели:
# R^2 = 0.9161 (скорректированный R^2 = 0.9099): модель объясняет 91,6 % вариации X_count.
# F-статистика = 147.4 (p < 0.001): модель значима.
#
#Значимость предикторов
# O_count: beta = 0.98183, p < 0.001 - значимый предиктор
# Temp:    beta = 0.11220, p = 0.001883 -значимый предиктор
# Intercept: beta = 6.27787, p < 0.001 - значим
#
# Вклад предикторов (ANOVA)
# O_count: Sum Sq = 365.90 - основной вклад в объяснение дисперсии
# Temp: Sum Sq = 15.35 - дополнительный вклад, но меньше
#
# Доверительные интервалы (95%)
# O_count: [0.864; 1.099] - не включает 0, подтверждает значимость
# Temp: [0.045; 0.179] — не включает 0, подтверждает значимость
#
# Остатки
# Медиана близка к 0 (Median = -0.2272), распределение относительно симметрично
# Диапазон остатков: от -1.60 до 2.51
#
# Модель статистически значима, оба предиктора вносят значимый вклад.
# O_count - основной предиктор, а Temp - дополнительный, но значимый.
# Необходимо проверить предпосылки регрессии:
# - нормальность остатков
# - гомоскедастичность 
# - линейность

# ==================================================================
# 4. Проверка мультиколлинеарности
# ==================================================================

# Проверяем мультиколлинеарность с помощью VIF (Variance Inflation Factor)
vif(model)

# Интерпретация VIF:
# VIF < 5 - мультиколлинеарность отсутствует или слабая
# VIF между 5 и 10 - умеренная мультиколлинеарность
# VIF > 10 - сильная мультиколлинеарность

# РЕЗУЛЬТАТ:
# O_count: VIF = 1.034
# Temp: VIF = 1.034
# VIF показывает отсутствие мультиколлинеарности, так как оба значения близки к 1
# Предикторы практически независимы, поэтому модель можно использовать.

# ==================================================================
# 5. Диагностика модели
# ==================================================================

# Получаем диагностические данные
# model_diag <- fortify(model)  # если доступно

# Получена ошибка, так как у меня новая версия пакета
# `fortify(<lm>)` was deprecated in ggplot2 4.0.0.
# ℹ Please use `broom::augment(<lm>)` instead.

# Использую broom::augment вместо устаревшего fortify
library(broom)
model_diag <- augment(model)

# 5.1. График расстояния Кука
ggplot(data = model_diag, aes(x = 1:nrow(model_diag), y = .cooksd)) +
       geom_col() +
       geom_hline(yintercept = 4/nrow(migration), linetype = 2, color = "red") +
       labs(title = "Расстояние Кука",
            x = "Номер наблюдения",
            y = "Расстояние Кука") +
       theme_minimal()

# ЗАМЕЧАНИЕ 1:
# Критически влиятельных наблюдений нет, но наблюдения 2, 23, 25 требуют внимания
# как потенциально влиятельные точки

# 5.2. График остатков от предсказанных значений
ggplot(data = model_diag, aes(x = .fitted, y = .std.resid)) +
       geom_point() +
       geom_hline(yintercept = 0, linetype = 2) +
       geom_smooth(method = "loess", se = TRUE) +
       labs(title = "Стандартизированные остатки от предсказанных значений",
            x = "Предсказанные значения",
            y = "Стандартизированные остатки") +
       theme_minimal() -> gg_resid

gg_resid

# ЗАМЕЧАНИЕ 2:
# На предсказанных значениях (22; 26) и (34; 36) кривая уходит вниз (до -0.75)
# Есть признаки нарушения линейности - модель занижает предсказания на низких и высоких значениях.

# 5.3. Графики остатков от предикторов
gg_resid + 
  aes(x = migration$O_count) +
  labs(title = "Остатки от количества ноликов",
       x = "Количество ноликов") -> res_O_count

gg_resid + 
  aes(x = migration$Temp) +
  labs(title = "Остатки от температуры",
       x = "Температура") -> res_Temp

# Все графики остатков вместе
grid.arrange(res_O_count, res_Temp, nrow = 1)

# ЗАМЕЧАНИЕ 3:
# Кривая остатков от кол-ва ноликов в целом близка к нулю,
# но есть отклонение на высоких значениях и небольшое расширение
# разброса на краях
#
# Наиболее выраженные проблемы с линейностью связаны с температурой.
# Возможно, связь с температурой нелинейна?

# ОБЩИЙ ВЫВОД:
# Модель имеет хорошее качество (R-squared = 0.9161),
# но есть небольшие нарушения предпосылок:
# - нарушение линейности (особенно для температуры)
# - нозможная гетероскедастичность на краях диапазонов
# - несколько потенциально влиятельных наблюдений

# 5.4. Квантильный график остатков (проверка нормальности)
qqPlot(model, id = FALSE)

#  ВЫВОД:
# Квантильный график (qqPlot) показывает нормальность распределения остатков
# Нормальность распределения в целом прослеживается

# Дополнительно: формальный тест нормальности остатков
shapiro.test(residuals(model))

# ВЫВОД:
# Остатки не вполне нормальны по формальному тесту (p = 0.047),
# но отклонение небольшое.
# Для n = 30 это может быть связано с чувствительностью теста.
# При умеренном отклонении наша модель регрессии должна быть приемлема

# 5.5. Проверка гомоскедастичности (формальные тесты)
# Тест Бройша-Пагана (Breusch-Pagan test)
bptest(model)

# Альтернативный тест: NCV Test (Non-Constant Variance Test)
ncvTest(model)

# ВЫВОД:
# Гомоскедастичность подтверждается обоими тестами (B-P test и NCV test).
# Дисперсия остатков постоянна, предпосылки выполняются.
# Это согласуется с визуальной оценкой графиков остатков.
# Модель можно использовать, но стоит учесть возможную нелинейность связи с температурой

# 5.6. Проверка линейности связи
# residualPlot из пакета car - специально для проверки линейности
residualPlot(model, pch = 19, id = FALSE)

# ВЫВОД: 
# В целом график остатков от предсказанных значений показывает гомоскедастичность
# кривая имеет U-образную форму, модель систематически занижает результат
# на краях диапазона и слегка завышает в середине.

# Проверка линейности для каждого предиктора отдельно
residualPlots(model, tests = FALSE)

# ВЫВОД
# Гомоскедастичность выполняется (разброс остатков постоянный, подтверждается тестами)
# Линейность по отдельным предикторам кажется выполняется
# Графики остатков от предикторов показывают отсутствие паттернов

# ОБЩИЙ ВЫВОД:
# Нарушение линейности проявляется в комбинации предикторов,
# а не в каждом по отдельности.
#
# Возможные причины:
# - отсутствие/наличие взаимодействия между предикторами
# - нелинейный эффект их комбинации
# - отсутствие квадратичного члена
#
# МОЖНО ПОПРОБОВАТЬ:
# 1. Добавить взаимодействие: X_count ~ O_count + Temp + O_count:Temp
# 2. Добавить квадратический член для температуры: X_count ~ O_count + Temp + I(Temp^2)

# ==================================================================
# 6. Визуализация зависимости в 3D
# ==================================================================

# Загружаем пакет для 3D графиков
library(plotly)

# 6.1. Датафрейм с экспериментальными данными
data_experimental <- data.frame(O_count = migration$O_count,
                                Temp = migration$Temp,
                                X_count = migration$X_count)

# 6.2. Датафрейм с предсказаниями модели
# Создаем сетку 100x100 точек
O_count_seq <- seq(min(migration$O_count), max(migration$O_count), length.out = 100)
Temp_seq <- seq(min(migration$Temp), max(migration$Temp), length.out = 100)

# Создаем все комбинации O_count и Temp
grid_data <- expand.grid(O_count = O_count_seq, Temp = Temp_seq)

# Вычисляем предсказания модели для всех точек сетки
grid_data$X_count <- predict(model, newdata = grid_data)

# 6.3. Создаем 3D график с полупрозрачными точками модели
plot_3d <- plot_ly() %>%
  add_trace(data = grid_data, # Предсказания модели - полупрозрачные точки с цветом по X_count
            x = ~O_count,
            y = ~Temp,
            z = ~X_count,
            type = "scatter3d",
            mode = "markers",
            marker = list(size = 3,
                          color = ~X_count,  # цвет зависит от значения X_count
                          colorscale = "Rainbow",  # красивая цветовая шкала
                          opacity = 0.6,  # полупрозрачность
                          showscale = TRUE,  # показываем шкалу цветов
                          symbol = "circle"),
            name = "Точки модели") %>%
  add_trace(data = data_experimental, # Экспериментальные данные - черные точки
            x = ~O_count,
            y = ~Temp,
            z = ~X_count,
            type = "scatter3d",
            mode = "markers",
            marker = list(size = 5,
                          color = "black",
                          symbol = "circle"),
            name = "Экспериментальные данные") %>%
  layout(title = "3D визуализация модели: X_count ~ O_count + Temp",   # Настройка осей и заголовка
         scene = list(xaxis = list(title = "Количество ноликов (O_count)"),
                      yaxis = list(title = "Температура (°C)"),
                      zaxis = list(title = "Количество крестиков (X_count)"),
                      camera = list(eye = list(x = 1.5, y = 1.5, z = 1.5))))

# Показываем график
plot_3d

# ==================================================================
# 7. Построение дополнительных моделей
# ==================================================================

# Вывод результатов основной модели
summary(model)

# 7.1. Модель с взаимодействием: X_count ~ O_count + Temp + O_count:Temp
model_interaction <- lm(X_count ~ O_count + Temp + O_count:Temp, data = migration)

# Вывод результатов модели с взаимодействием
summary(model_interaction)

# 7.2. Модель с квадратическим членом для температуры: X_count ~ O_count + Temp + I(Temp^2)
model_quadratic <- lm(X_count ~ O_count + Temp + I(Temp^2), data = migration)

# Вывод результатов модели с квадратическим членом
summary(model_quadratic)

# СРАВНЕНИЕ МОДЕЛЕЙ:

# M1 = X_count ~ O_count + Temp 
# M2 = X_count ~ O_count + Temp + O_count:Temp
# M3 = X_count ~ O_count + Temp + I(Temp^2)

# Модель         |       M1      |      M2           |      M3
# ------------------------------------------------------------------------
# Предикторы     | 2             | 3                 | 3
# Знач. коэфф.   | O_count, Temp | O_count           | O_count
# Intercept      | значим        | незначим          | значим
# Взаимодействие | нет           | незначимо (p=0.2) | нет
# Квадрат. член  | нет           | нет               | незначим (p= 0.61)
# R-squared.     | 0.9161        | 0.9214            | 0.9169
# Adjusted R-sq. | 0.9099        | 0.9124            | 0.9074
# Residual SE    | 1.137         | 1.121             | 1.153
# F-statistic    | 147.4         | 101.6             | 95.7
# p-value        | < 0.001       | < 0.001           | < 0.001

# ВЫВОД:
# Добавление взаимодействия O_count*Temp и квадратичного члена температуры
# не привело к статистически значимому улучшению модели.
# Основная линейная модель с предикторами O_count и Temp продемонстрировала
# наилучший баланс между объясняющей способностью и простотой,
# что позволяет считать её наиболее адекватной для описания
# зависимости X_count от факторов среды.

# ---- НЕОБЯЗАТЕЛЬНАЯ ЧАСТЬ (для визуализации других моделей) ----

# ==================================================================
# 8. Визуализация дополнительных моделей в 3D
# ==================================================================

# 8.1. Визуализация модели с взаимодействием
# Создаем сетку 100x100 точек (как для базовой модели)
O_count_seq_interaction <- seq(min(migration$O_count), max(migration$O_count), length.out = 100)
Temp_seq_interaction <- seq(min(migration$Temp), max(migration$Temp), length.out = 100)

# Создаем все комбинации O_count и Temp
grid_data_interaction <- expand.grid(O_count = O_count_seq_interaction, Temp = Temp_seq_interaction)

# Вычисляем предсказания модели с взаимодействием
grid_data_interaction$X_count <- predict(model_interaction, newdata = grid_data_interaction)

# 3D график модели с взаимодействием (палитра "Plasma")
plot_3d_interaction <- plot_ly() %>%
  add_trace(data = grid_data_interaction,
            x = ~O_count,
            y = ~Temp,
            z = ~X_count,
            type = "scatter3d",
            mode = "markers",
            marker = list(size = 3,
                          color = ~X_count,
                          colorscale = "Electric",
                          opacity = 0.6,
                          showscale = TRUE,
                          symbol = "circle"),
            name = "Точки модели (взаимодействие)") %>%
  add_trace(data = data_experimental,
            x = ~O_count,
            y = ~Temp,
            z = ~X_count,
            type = "scatter3d",
            mode = "markers",
            marker = list(size = 5, color = "black",symbol = "circle"),
            name = "Экспериментальные данные") %>%
  layout(title = "3D визуализация модели: X_count ~ O_count + Temp + O_count:Temp",
         scene = list(xaxis = list(title = "Количество ноликов (O_count)"),
                      yaxis = list(title = "Температура (°C)"),
                      zaxis = list(title = "Количество крестиков (X_count)"),
                      camera = list(eye = list(x = 1.5, y = 1.5, z = 1.5))))

plot_3d_interaction

# 8.2. Визуализация модели с квадратическим членом
# Создаем сетку 100x100 точек
O_count_seq_quadratic <- seq(min(migration$O_count), max(migration$O_count), length.out = 100)
Temp_seq_quadratic <- seq(min(migration$Temp), max(migration$Temp), length.out = 100)

# Создаем все комбинации O_count и Temp
grid_data_quadratic <- expand.grid(O_count = O_count_seq_quadratic, Temp = Temp_seq_quadratic)

# Вычисляем предсказания модели с квадратическим членом
grid_data_quadratic$X_count <- predict(model_quadratic, newdata = grid_data_quadratic)

# 3D график модели с квадратическим членом (палитра "Inferno")
plot_3d_quadratic <- plot_ly() %>%
  add_trace(data = grid_data_quadratic,
            x = ~O_count,
            y = ~Temp,
            z = ~X_count,
            type = "scatter3d",
            mode = "markers",
            marker = list(size = 3,
                          color = ~X_count,
                          colorscale = "Viridis", 
                          opacity = 0.6,
                          showscale = TRUE,
                          symbol = "circle"),
            name = "Точки модели (квадратический член)") %>%
  add_trace(data = data_experimental,
            x = ~O_count,
            y = ~Temp,
            z = ~X_count,
            type = "scatter3d",
            mode = "markers",
            marker = list(size = 5, color = "black", symbol = "circle"),
            name = "Экспериментальные данные") %>%
  layout(title = "3D визуализация модели: X_count ~ O_count + Temp + I(Temp^2)",
         scene = list(xaxis = list(title = "Количество ноликов (O_count)"),
                      yaxis = list(title = "Температура (°C)"),
                      zaxis = list(title = "Количество крестиков (X_count)"),
                      camera = list(eye = list(x = 1.5, y = 1.5, z = 1.5))))

plot_3d_quadratic
