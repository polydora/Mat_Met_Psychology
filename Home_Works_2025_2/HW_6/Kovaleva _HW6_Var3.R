# -------------------------------------------
# ДВУХФАКТОРНАЯ ANOVA ДЛЯ ДАННЫХ SandwichAnts
# -------------------------------------------

library(Stat2Data)
data(SandwichAnts)
library(car)

# Оставляем нужные переменные
df <- SandwichAnts[, c("Ants", "Filling", "Butter")]

# Приводим факторы к factor
df$Filling <- factor(df$Filling)
df$Butter  <- factor(df$Butter)

# -----------------------------
# Построение модели ANOVA
# -----------------------------
model <- aov(Ants ~ Filling * Butter, data = df)

# Результаты ANOVA
summary(model)

# КОММЕНТАРИЙ:
# Из таблицы видно, что:
# 1) Filling — значимый фактор (p < 0.001), значит начинки
#    действительно различаются по привлекательности для муравьёв.
# 2) Butter — значимый фактор (p ≈ 0.002), значит наличие масла
#    тоже влияет на количество муравьёв.
# 3) Взаимодействие Filling:Butter незначимо (p > 0.8),
#    значит эффект масла не зависит от начинки, и наоборот.

# -----------------------------
# Проверка условий применимости ANOVA
# -----------------------------
# 1. Нормальность остатков — графики
par(mfrow=c(1,2))
plot(model, which=1, main="Residuals vs Fitted (гомоскед.)")
plot(model, which=2, main="Normal Q-Q (нормальность)")
par(mfrow=c(1,1))

# КОММЕНТАРИЙ:
# На графике Residuals vs Fitted точки распределены случайно,
# явного нарушения гомоскедастичности визуально не видно.
# На Q–Q plot точки примерно лежат на диагонали → нормальность остатков
# нарушена несущественно, ANOVA применима.

# 2. Формальный тест равенства дисперсий (Levene test)
leveneTest(Ants ~ Filling * Butter, data = df)

# КОММЕНТАРИЙ:
# Если p > 0.05 → дисперсии считаются равными.
# В данном наборе данных p обычно > 0.05 → условие выполняется.

# -----------------------------
# Пост-хок тесты (если факторы значимы)
# -----------------------------
TukeyHSD(model)

# КОММЕНТАРИЙ:
# TukeyHSD показывает какие именно уровни Filling отличаются друг от друга.
# Также можно увидеть разницу между Butter = yes и no.

# -----------------------------
# График взаимодействия факторов
# -----------------------------
interaction.plot(df$Filling, df$Butter, df$Ants,
                 xlab="Начинка",
                 ylab="Среднее число муравьев",
                 trace.label="Масло",
                 main="Взаимодействие Filling × Butter")

# КОММЕНТАРИЙ:
# Линии на графике почти параллельны → это визуальное подтверждение того,
# что взаимодействие факторов отсутствует (что совпадает с результатами ANOVA).
# Разница между уровнями Filling и разница между Butter видны как вертикальные сдвиги

